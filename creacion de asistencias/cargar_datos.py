import mysql.connector
from mysql.connector import Error

# --- CONFIGURACI√ìN ---
DB_CONFIG = {
    'host': 'localhost',
    'database': 'asistencias_db',
    'user': 'vex',
    'password': '1234'
}

fechas = [
    '2025-02-14', '2025-02-21', '2025-02-28',
    '2025-03-01', '2025-03-05', '2025-03-07', '2025-03-12', '2025-03-14',
    '2025-03-19', '2025-03-21', '2025-03-22', '2025-03-26', '2025-03-28', '2025-03-29',
    '2025-04-04', '2025-04-11', '2025-04-12', '2025-04-17', '2025-04-18',
    '2025-05-02', '2025-05-07', '2025-05-09', '2025-05-16', '2025-05-23', '2025-05-30',
    '2025-06-06', '2025-06-13', '2025-06-20',
    '2025-07-04', '2025-07-11', '2025-07-16', '2025-07-18', '2025-07-19', '2025-07-21',
    '2025-07-25', '2025-07-26', '2025-07-28',
    '2025-08-15', '2025-08-22',
    '2025-09-05', '2025-09-12', '2025-09-19', '2025-09-26'
]

ESPERADO_VALORES = len(fechas)  # 43

# --- Tus datos crudos (aseg√∫rate de que est√©n completos) ---
datos_crudos = [
    # ... (tu lista completa aqu√≠)
    ["Huberto Hern√°ndez", "Viol√≠n I", "2", "2", "2", "2", "-1", "2", "-1", "2", "-", "2", "2", "2", "2", "2", "-", "2", "2", "-", "-", "-1", "-", "2", "2", "-1", "-", "2", "-1", "2", "-1", "-1", "2", "2", "0", "2", "-1", "0", "2", "-1", "2", "2", "-", "-", "2"],
    ["Gabriel Chinchilla", "Viol√≠n I", "2", "2", "2", "2", "2", "2", "2", "2", "-", "2", "2", "2", "2", "2", "2", "2", "2", "-", "-", "0", "-", "0", "2", "2", "-", "2", "2", "2", "2", "2", "2", "2", "2", "2", "2", "2", "2", "-", "0", "2", "-", "-", "2"],
    ["Ninfa Montoya", "Viol√≠n I", "2", "2", "2", "-1", "0", "2", "2", "2", "-", "2", "2", "2", "2", "2", "-", "0", "2", "2", "2", "2", "-", "0", "2", "2", "-", "0", "2", "2", "2", "2", "0", "2", "2", "2", "2", "2", "2", "0", "0", "2", "-", "-", "2"],
    ["Pedro Melgar", "Viol√≠n I", "0", "0", "2", "0", "0", "0", "0", "0", "-", "0", "0", "0", "0", "0", "-", "2", "2", "-", "-", "0", "-", "0", "0", "0", "-", "-1", "-1", "2", "0", "0", "0", "0", "0", "0", "2", "2", "0", "0", "-", "-", "-", "0"],
    ["Lisseth Men√©ndez", "Viol√≠n I", "-1", "2", "0", "0", "2", "2", "0", "0", "-", "2", "0", "2", "2", "2", "-", "0", "2", "-", "-", "0", "-", "-1", "0", "-1", "-", "2", "0", "2", "0", "0", "2", "0", "0", "2", "2", "0", "2", "-1", "2", "2", "-", "-", "0"],
    ["Kimberly Chac√≥n", "Viol√≠n I", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "2", "2", "-1", "-", "0", "2", "2", "0", "2", "0", "0", "0", "0", "2", "0", "2", "-1", "-1", "0", "-", "-", "0"],
    ["Violeta Quintanilla", "Viol√≠n II", "2", "2", "2", "-1", "0", "2", "2", "2", "-", "2", "2", "2", "2", "2", "-", "0", "0", "2", "2", "-1", "-", "2", "2", "2", "-", "2", "0", "2", "0", "2", "2", "2", "2", "2", "2", "0", "2", "2", "2", "2", "-", "-", "-1"],
    ["Gustavo Oviedo", "Viol√≠n II", "0", "2", "2", "0", "0", "2", "2", "2", "-", "2", "2", "2", "2", "2", "-", "0", "2", "2", "2", "2", "-", "2", "-1", "-1", "-", "2", "2", "2", "0", "0", "2", "0", "0", "2", "2", "0", "2", "2", "2", "2", "-", "-", "-1"],
    ["Pedro G√≥mez", "Viol√≠n II", "2", "2", "2", "2", "2", "2", "2", "2", "-", "2", "2", "2", "2", "2", "-", "0", "0", "2", "2", "2", "-", "2", "2", "2", "-", "2", "2", "2", "2", "2", "2", "2", "2", "2", "2", "2", "0", "2", "-", "-", "-", "2"],
    ["Alan Mendoza", "Viol√≠n II", "-", "2", "-1", "2", "-1", "0", "-1", "-1", "-", "-1", "-1", "-1", "2", "-1", "-", "0", "2", "-", "-", "-1", "-", "-1", "-1", "-1", "-", "-1", "0", "-1", "-1", "-1", "-1", "-1", "-1", "-1", "-1", "-1", "-1", "-1", "2", "0", "-", "-", "-1"],
    ["Keyny Corpe√±o", "Viol√≠n II", "-", "2", "2", "2", "-1", "2", "0", "0", "-", "2", "2", "0", "0", "0", "-", "0", "2", "-", "-", "0", "-", "2", "2", "0", "-", "0", "0", "2", "0", "0", "0", "2", "2", "2", "2", "0", "2", "0", "-1", "0", "-", "-", "-1"],
    ["Fabricio Ben√≠tez", "Viola", "2", "2", "2", "0", "0", "0", "0", "2", "-", "2", "2", "2", "2", "2", "-", "2", "2", "2", "2", "2", "-", "2", "2", "2", "-", "2", "0", "2", "0", "0", "0", "2", "2", "2", "2", "-", "2", "0", "-", "-", "-", "2"],
    ["Moises L√≥pez", "Viola", "-1", "2", "-1", "-1", "-1", "-1", "0", "-1", "-", "2", "0", "2", "2", "2", "-", "0", "2", "-", "-", "-1", "-", "-1", "-1", "-1", "-", "2", "0", "0", "0", "0", "0", "0", "2", "2", "2", "0", "2", "-", "-1", "0", "-", "-", "-1"],
    ["Gabriela Hern√°ndez", "Viola", "-", "2", "2", "2", "2", "2", "0", "0", "-", "2", "2", "2", "2", "2", "-", "0", "0", "-", "-", "-1", "-", "-1", "2", "2", "-", "2", "2", "2", "2", "2", "2", "0", "2", "2", "2", "0", "2", "-", "2", "2", "-", "-", "2"],
    ["Daniela Hern√°ndez", "Violonchelo", "2", "2", "2", "2", "-1", "2", "0", "0", "-", "2", "2", "2", "2", "2", "-", "2", "2", "-", "-", "-1", "-", "2", "2", "2", "-", "2", "0", "2", "0", "0", "0", "0", "2", "2", "2", "-", "0", "0", "-", "-", "-", "-1"],
    ["Diego Cruz", "Violonchelo", "2", "2", "2", "2", "-1", "2", "0", "2", "-", "2", "2", "2", "2", "2", "-", "0", "0", "-", "-", "2", "-", "-1", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "2", "2", "-", "-", "-1"],
    ["Erick Alfaro", "Flauta", "2", "2", "2", "-", "-", "2", "-", "0", "-1", "2", "-", "-", "0", "-", "2", "-", "-", "2", "2", "-", "-", "-1", "2", "0", "2", "2", "2", "0", "2", "0", "2", "-", "-", "2", "-", "2", "2", "2", "-", "0", "2", "-1", "-1", "-1"],
    ["Liliana Gonz√°lez", "Flauta", "-1", "-1", "2", "-", "-", "-1", "-", "-1", "-1", "2", "-", "-", "0", "-", "2", "-", "-", "-", "-", "-", "-1", "-1", "0", "2", "0", "-1", "-1", "-", "0", "0", "-", "-", "0", "-", "2", "2", "2", "-", "-1", "0", "-1", "-1", "-1"],
    ["Manuel Castellanos", "Corno Franc√©s", "0", "2", "2", "-", "-", "2", "-", "0", "2", "2", "-", "-", "2", "-", "2", "-", "-", "-", "-", "-", "2", "2", "2", "2", "0", "2", "2", "2", "0", "2", "-", "-", "2", "-", "2", "-", "2", "0", "-1", "2", "2"],
    ["Gabriela Orellana", "Trompeta", "0", "2", "2", "-", "-", "2", "-", "0", "0", "2", "-", "-", "0", "-", "2", "-", "-", "2", "2", "-", "-", "2", "0", "0", "0", "0", "0", "0", "-", "-", "-", "-", "-", "-", "-", "-", "-", "-", "0", "2", "2", "0", "2"],
    ["Gerardo N√∫√±ez", "Trompeta", "2", "2", "2", "-", "-", "2", "-", "2", "2", "2", "-", "-", "2", "-", "0", "-", "-", "2", "2", "-", "-", "2", "2", "2", "0", "2", "0", "2", "0", "2", "-", "-", "-1", "-", "2", "-", "-1", "0", "0", "0", "0"],
    ["Jovanne Portales", "Trompeta", "0", "2", "-1", "-", "-", "-1", "-", "2", "-1", "2", "-", "-", "2", "-", "-1", "-", "-", "-", "-", "-", "0", "2", "2", "-1", "2", "2", "-1", "2", "2", "2", "-", "-", "-1", "-", "2", "2", "-", "2", "2", "-1", "2", "2"],
    ["Julio Garc√≠a", "Tromb√≥n", "2", "2", "0", "-", "-", "2", "-", "2", "-1", "2", "-", "-", "2", "-", "2", "-", "-", "-", "-", "-", "0", "2", "0", "0", "0", "0", "-1", "0", "2", "0", "-", "-", "2", "-", "2", "-", "0", "2", "-1", "0", "0"]
]

# --- Funci√≥n de mapeo ---
def valor_a_id_tipo(valor):
    if valor == "2":
        return 1
    elif valor == "-1":
        return 2
    elif valor == "0":
        return 3
    else:
        return 4

# --- Validar y corregir filas ---
datos_corregidos = []
for idx, fila in enumerate(datos_crudos):
    nombre = fila[0]
    instrumento = fila[1]
    valores = fila[2:]
    
    if len(valores) < ESPERADO_VALORES:
        print(f"‚ö†Ô∏è  Fila {idx+1} ({nombre}): {len(valores)} valores ‚Üí completando con '-'")
        valores = valores + ["-"] * (ESPERADO_VALORES - len(valores))
    elif len(valores) > ESPERADO_VALORES:
        print(f"‚ö†Ô∏è  Fila {idx+1} ({nombre}): {len(valores)} valores ‚Üí truncando")
        valores = valores[:ESPERADO_VALORES]
    
    datos_corregidos.append([nombre, instrumento] + valores)

# --- Cargar en BD ---
try:
    conn = mysql.connector.connect(**DB_CONFIG)
    cursor = conn.cursor()

    # Insertar usuarios
    usuarios = [(f[0], f[1]) for f in datos_corregidos]
    cursor.executemany(
        "INSERT IGNORE INTO usuario (nombre, instrumento) VALUES (%s, %s)",
        usuarios
    )
    print(f"‚úÖ Usuarios insertados: {cursor.rowcount}")

    # Insertar fechas
    fechas_tuples = [(f,) for f in fechas]
    cursor.executemany(
        "INSERT IGNORE INTO evento (fecha) VALUES (%s)",
        fechas_tuples
    )
    print(f"‚úÖ Fechas insertadas: {cursor.rowcount}")

    # Insertar asistencias
    asistencias = []
    for fila in datos_corregidos:
        nombre = fila[0]
        cursor.execute("SELECT id_usuario FROM usuario WHERE nombre = %s", (nombre,))
        res = cursor.fetchone()
        if not res:
            print(f"‚ùå Usuario no encontrado: {nombre}")
            continue
        id_usuario = res[0]

        for i, fecha in enumerate(fechas):
            valor = fila[2 + i]  # ‚úÖ Ahora seguro
            id_tipo = valor_a_id_tipo(valor)

            cursor.execute("SELECT id_evento FROM evento WHERE fecha = %s", (fecha,))
            res_ev = cursor.fetchone()
            if not res_ev:
                continue
            id_evento = res_ev[0]

            asistencias.append((id_usuario, id_evento, id_tipo))

    cursor.executemany(
        "INSERT IGNORE INTO asistencia (id_usuario, id_evento, id_tipo) VALUES (%s, %s, %s)",
        asistencias
    )
    print(f"‚úÖ Asistencias insertadas: {cursor.rowcount}")

    conn.commit()
    print("\nüéâ ¬°Carga completada con √©xito!")

except Error as e:
    print(f"‚ùå Error de base de datos: {e}")
    if 'conn' in locals() and conn.is_connected():
        conn.rollback()
finally:
    if 'conn' in locals() and conn.is_connected():
        cursor.close()
        conn.close()
        print("üîå Conexi√≥n cerrada.")